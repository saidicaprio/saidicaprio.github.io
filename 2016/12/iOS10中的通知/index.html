<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8"/>
    <meta http-equiv="X-UA-Compatible" content="IE=edge"/>
    
    <title>iOS10中的通知 | Sai&#39;s Cabin</title>
    <meta name="renderer" content="webkit">
    <meta name="HandheldFriendly" content="True">
    <meta name="MobileOptimized" content="320">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

    <meta name="description" content="Hi, I&#39;m SaiDicaprio, a iOS Developer from China.">

    <meta name="twitter:card" content="summary">
    <meta name="twitter:title" content="iOS10中的通知 | Sai&#39;s Cabin">
    <meta name="twitter:description" content="Hi, I&#39;m SaiDicaprio, a iOS Developer from China.">

    <meta property="og:type" content="article">
    <meta property="og:title" content="iOS10中的通知 | Sai&#39;s Cabin">
    <meta property="og:description" content="Hi, I&#39;m SaiDicaprio, a iOS Developer from China.">

    
    <meta name="author" content="贺嘉炜">
    
    <link rel="stylesheet" href="/css/vno.css">
    <link rel="stylesheet" href="//netdna.bootstrapcdn.com/font-awesome/4.1.0/css/font-awesome.min.css">

    

    <meta name="generator" content="hexo"/>
    
    <link rel="alternate" type="application/rss+xml" title="Sai&#39;s Cabin" href="/atom.xml">
    

    <link rel="canonical" href="https://saidicaprio.com/2016/12/iOS10中的通知/"/>

                 
</head>

<body class="home-template no-js">
    <script src="//cdn.bootcss.com/jquery/2.1.4/jquery.min.js"></script>
    <script src="/js/main.js"></script>
    <span class="mobile btn-mobile-menu">
        <i class="fa fa-list btn-mobile-menu__icon"></i>
        <i class="fa fa-angle-up btn-mobile-close__icon hidden"></i>
    </span>

    
<header class="panel-cover panel-cover--collapsed" style="background-image: url(/images/background-cover.jpg)">
  <div class="panel-main">
    <div class="panel-main__inner panel-inverted">
    <div class="panel-main__content">

        <a href="/" title="前往 Sai&#39;s Cabin 的主页"><img src="/images/avatar.jpg" width="80" alt="Sai&#39;s Cabin logo" class="panel-cover__logo logo" /></a>
        <h1 class="panel-cover__title panel-title"><a href="/" title="link to homepage for Sai&#39;s Cabin">Sai&#39;s Cabin</a></h1>
        
        <span class="panel-cover__subtitle panel-subtitle">落月摇情满江树</span>
        
        <hr class="panel-cover__divider" />
        <p class="panel-cover__description">Hi, I'm SaiDicaprio, a iOS Developer from China.</p>
        <hr class="panel-cover__divider panel-cover__divider--secondary" />

        <div class="navigation-wrapper">
          <div>
          <nav class="cover-navigation cover-navigation--primary">
            <ul class="navigation">
              <li class="navigation__item"><a href="/#blog" title="访问博客" class="blog-button">博客</a></li>
            
              <li class="navigation__item"><a href="/">首页</a></li>
            
              <li class="navigation__item"><a href="./aboutme">关于</a></li>
            
            </ul>
          </nav>
          </div>
          <div>
          <nav class="cover-navigation navigation--social">
  <ul class="navigation">

  <!-- Weibo-->
  

  <!-- Github -->
  
  <li class="navigation__item">
    <a href="https://github.com/hjw6160602" title="查看我的GitHub主页" target="_blank">
      <i class='social fa fa-github'></i>
      <span class="label">Github</span>
    </a>
  </li>


<!-- Stack Overflow -->
        

  <!-- Google Plus -->
  

<!-- Facebook -->

  
<!-- Twitter -->

  

  <li class="navigation__item">
    <a href="/atom.xml" title="RSS" target="_blank">
      <i class='social fa fa-rss'></i>
      <span class="label">RSS</span>
    </a>
  </li>



  </ul>
</nav>

          </div>
        </div>

      </div>

    </div>

    <div class="panel-cover--overlay cover-blue"></div>
  </div> 
</header>

    <div class="content-wrapper">
        <div class="content-wrapper__inner">
            <article class="post-container post-container--single">

  <header class="post-header">
    <div class="post-meta">
      <time datetime="2016-12-24T11:30:29.000Z" class="post-list__meta--date date">2016-12-24</time> &#8226; <span class="post-meta__tags tags">于&nbsp;
  <a class="tag-link" href="/tags/能工巧匠集/">能工巧匠集</a>
 </span>
      <span class="page-pv">
      &nbsp;阅读&nbsp;<span id="busuanzi_value_page_pv"><i class="fa fa-spinner fa-spin"></i></span>
      </span> 
   
    </div>
    <h1 class="post-title">iOS10中的通知</h1>
  </header>

  <section class="post">
    <p>iOS10对推送通知的内容进行了一次大的重构，加入了一个新的框架 <code>UserNotifications.framework</code> 来集中管理和使用 iOS 系统中通知的功能，除此之外，还增加了很多额外的很好用的功能，比如：</p>
<ul>
<li>撤回一条通知</li>
<li>更新已经展示的通知</li>
<li>中途修改通知内容</li>
<li>在通知中展示图片视频</li>
<li>自定义通知 UI 等</li>
</ul>
<h2 id="一、普通通知与其流程"><a href="#一、普通通知与其流程" class="headerlink" title="一、普通通知与其流程"></a>一、普通通知与其流程</h2><p>远程通知 (<code>Remote Notification</code>)的工作流程：</p>
<p><img src="https://willjayh.oss-cn-shanghai.aliyuncs.com/imgs/remoteNotificationWorkFlow.png" alt=""></p>
<p>本地通知(<code>Local Notification</code>)的工作流程：</p>
<p><img src="https://willjayh.oss-cn-shanghai.aliyuncs.com/imgs/notification-flow.png" alt=""></p>
<h3 id="1-1-基本流程"><a href="#1-1-基本流程" class="headerlink" title="1.1 基本流程"></a>1.1 基本流程</h3><p>首先你需要向用户请求推送权限，然后发送通知。对于发送出的通知，如果你的应用位于后台或者没有运行的话，系统将通过用户允许的方式 (弹窗，横幅，或者是在通知中心) 进行显示。如果你的应用已经位于前台正在运行，你可以自行决定要不要显示这个通知。最后，如果你希望用户点击通知能有打开应用以外的额外功能的话，你也需要进行处理。</p>
<h3 id="1-2-权限申请"><a href="#1-2-权限申请" class="headerlink" title="1.2 权限申请"></a>1.2 权限申请</h3><h4 id="1-2-1-通用权限"><a href="#1-2-1-通用权限" class="headerlink" title="1.2.1 通用权限"></a>1.2.1 通用权限</h4><p>iOS 8 之前，本地推送 (<code>UILocalNotification</code>) 和远程推送 (<code>Remote Notification</code>) 是区分对待的，应用只需要在进行远程推送时获取用户同意。iOS 8 对这一行为进行了规范，因为无论是本地推送还是远程推送，其实在用户看来表现是一致的，都是打断用户的行为。因此从 iOS 8 开始，这两种通知都需要申请权限。于是就有了下面这一段请求用户通知权限的代码：<br><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#ifdef __IPHONE_8_0</span></span><br><span class="line">    <span class="comment">// 注册接收通知的类型</span></span><br><span class="line">    <span class="built_in">UIUserNotificationType</span> type = <span class="built_in">UIUserNotificationTypeBadge</span> | <span class="built_in">UIUserNotificationTypeSound</span> | <span class="built_in">UIUserNotificationTypeAlert</span>;</span><br><span class="line">    <span class="built_in">UIUserNotificationSettings</span> *settings = [<span class="built_in">UIUserNotificationSettings</span> settingsForTypes:type categories:<span class="literal">nil</span>];</span><br><span class="line">    [application registerUserNotificationSettings:settings];</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 注册允许接收远程推送通知</span></span><br><span class="line">    [application registerForRemoteNotifications];</span><br><span class="line"><span class="meta">#else</span></span><br><span class="line">    <span class="comment">// 如果是iOS 3.0 ~ 7.0，使用以下方法注册</span></span><br><span class="line">    [application registerForRemoteNotificationTypes:<span class="built_in">UIUserNotificationTypeAlert</span> | <span class="built_in">UIUserNotificationTypeBadge</span> | <span class="built_in">UIUserNotificationTypeSound</span>];</span><br><span class="line"><span class="meta">#endif</span></span><br></pre></td></tr></table></figure></p>
<p>iOS 10 里进一步消除了本地通知和推送通知的区别。向用户申请通知权限非常简单：</p>
<p><strong>Objective-C:</strong><br><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[[UNUserNotificationCenter currentNotificationCenter] requestAuthorizationWithOptions:UNAuthorizationOptionBadge | UNAuthorizationOptionSound | UNAuthorizationOptionAlert | UNAuthorizationOptionCarPlay completionHandler:^(<span class="built_in">BOOL</span> granted, <span class="built_in">NSError</span> * _Nullable error) &#123;</span><br><span class="line">    <span class="keyword">if</span> (granted)&#123;</span><br><span class="line">        <span class="comment">//用户允许进行通知</span></span><br><span class="line">    &#125; </span><br><span class="line">&#125;];</span><br></pre></td></tr></table></figure></p>
<p><strong>Swift:</strong><br><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">UNUserNotificationCenter</span>.current().requestAuthorization(options: [.alert, .sound, .badge]) &#123;</span><br><span class="line">    granted, error <span class="keyword">in</span></span><br><span class="line">    <span class="keyword">if</span> granted &#123;</span><br><span class="line">        <span class="comment">// 用户允许进行通知</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>注意：在使用 UN 开头的 API 的时候，不要忘记导入 UserNotifications 框架：</p>
<p><strong>Objective-C:</strong><br><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#import <span class="meta-string">&lt;UserNotifications/UserNotifications.h&gt;</span></span></span><br></pre></td></tr></table></figure></p>
<p><strong>Swift:</strong><br><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> UserNotifications</span><br></pre></td></tr></table></figure></p>
<p>第一次调用这个方法时，会弹出一个系统弹窗。</p>
<p><img src="https://willjayh.oss-cn-shanghai.aliyuncs.com/imgs/Authorization.png" alt=""></p>
<p>要注意的是，一旦用户拒绝了这个请求，再次调用该方法也不会再进行弹窗，想要应用有机会接收到通知的话，用户必须自行前往系统的设置中为你的应用打开通知。</p>
<h4 id="1-2-2-远程推送"><a href="#1-2-2-远程推送" class="headerlink" title="1.2.2 远程推送"></a>1.2.2 远程推送</h4><p>一旦用户同意后，你就可以在应用中发送本地通知了。不过如果你通过服务器发送远程通知的话，还需要多一个获取用户 token 的操作。你的服务器可以使用这个 token 将用向 <code>Apple Push Notification service</code> 苹果推送通知服务器(以下简称为APNs)提交请求，然后 APNs 通过 token 识别设备和应用，将通知推给用户。</p>
<blockquote>
<p>注意：注册 APNs 的 deviceToken 的操作是iOS10中，<strong>唯一</strong> 不在新框架中的 API。</p>
</blockquote>
<ul>
<li>使用 <code>UIApplication</code> 的<code>registerForRemoteNotifications</code> 方法提交 token 请求来注册远程通知</li>
<li>在 <code>AppDelegate</code> 的<code>application:didRegisterForRemoteNotificationsWithDeviceToken:</code> 回调方法中获取用户 token</li>
</ul>
<p>下面附上两张图来回顾下DeviceToken的获取过程。</p>
<p><img src="https://willjayh.oss-cn-shanghai.aliyuncs.com/imgs/getDeviceToken1.png" alt=""></p>
<p>手机设备向APNs发起获取token的请求，APNs通过描述文件里的手机设备信息生成deviceID，通过App信息生成token包，最终将其译成密文token发送给手机设备，然后手机设备再将token发送给公司服务器。</p>
<p><img src="https://willjayh.oss-cn-shanghai.aliyuncs.com/imgs/getDeviceToken2.png" alt=""></p>
<h3 id="1-3-发送通知"><a href="#1-3-发送通知" class="headerlink" title="1.3 发送通知"></a>1.3 发送通知</h3><p>让我们先来看看iOS10之前的通知是如何发送的：<br><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 1.创建本地推送通知对象</span></span><br><span class="line"><span class="built_in">UILocalNotification</span> *ln = [[<span class="built_in">UILocalNotification</span> alloc] init];</span><br><span class="line"><span class="comment">// 2.设置通知属性</span></span><br><span class="line"><span class="comment">// 音效文件名</span></span><br><span class="line">ln.soundName = <span class="string">@"sound.wav"</span>;</span><br><span class="line"><span class="comment">// 通知的具体内容</span></span><br><span class="line">ln.alertBody = <span class="string">@"重大新闻：xxxx xxxx被调查了...."</span>;</span><br><span class="line"><span class="comment">// 锁屏界面显示的小标题（"滑动来" + alertAction）</span></span><br><span class="line">ln.alertAction = <span class="string">@"查看新闻吧"</span>;</span><br><span class="line"><span class="comment">// 通知第一次发出的时间(5秒后发出)</span></span><br><span class="line">ln.fireDate = [<span class="built_in">NSDate</span> dateWithTimeIntervalSinceNow:<span class="number">5</span>];</span><br><span class="line"><span class="comment">// 设置时区（跟随手机的时区）</span></span><br><span class="line">ln.timeZone = [<span class="built_in">NSTimeZone</span> defaultTimeZone];</span><br><span class="line"><span class="comment">// 设置app图标徽章数字</span></span><br><span class="line">ln.applicationIconBadgeNumber = <span class="number">5</span>;</span><br><span class="line"><span class="comment">// 设置通知的额外信息</span></span><br><span class="line">ln.userInfo = @&#123;</span><br><span class="line">                <span class="string">@"icon"</span> : <span class="string">@"test.png"</span>,</span><br><span class="line">                <span class="string">@"title"</span> : <span class="string">@"重大新闻"</span>,</span><br><span class="line">                <span class="string">@"time"</span> : <span class="string">@"2016-11-14 11:19"</span>,</span><br><span class="line">                <span class="string">@"body"</span> : <span class="string">@"韩国民众阻止朴槿惠下台群众示威运动！"</span></span><br><span class="line">                &#125;;</span><br><span class="line"><span class="comment">// 3.调度通知（启动任务）</span></span><br><span class="line">[[<span class="built_in">UIApplication</span> sharedApplication] scheduleLocalNotification:ln];</span><br></pre></td></tr></table></figure></p>
<p>可以看到，iOS10之前的通知还是基于对象<code>UILocalNotification</code>来发送的。</p>
<p>那么在iOS10中，<code>UserNotifications.framework</code> 中对通知进行了统一。我们通过通知的内容 (<code>UNNotificationContent</code>)，发送的时机 (<code>UNNotificationTrigger</code>) 以及一个发送通知的 <code>String</code> 类型的标识符，来生成一个<code>UNNotificationRequest</code> 类型的发送请求。最后，我们将这个请求添加到<code>[UNUserNotificationCenter currentNotificationCenter]</code> 中，就可以等待通知到达了：</p>
<p><strong>Objective-C:</strong><br><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 1. 创建通知内容</span></span><br><span class="line">UNMutableNotificationContent *content = [[UNMutableNotificationContent alloc]init];</span><br><span class="line">content.title = <span class="string">@"时间戳通知"</span>;</span><br><span class="line">content.body = <span class="string">@"我的第一条通知"</span>;</span><br><span class="line"><span class="comment">// 2. 创建发送触发器</span></span><br><span class="line">UNTimeIntervalNotificationTrigger *trigger = [UNTimeIntervalNotificationTrigger triggerWithTimeInterval:timeInterval repeats:<span class="literal">NO</span>];</span><br><span class="line"><span class="comment">// 3. 发送请求标识符</span></span><br><span class="line"><span class="built_in">NSString</span> *requestIdentifier = [NotificationHandler userNotiRawValue:<span class="keyword">self</span>.notificationType];</span><br><span class="line"><span class="comment">// 4. 创建一个发送请求</span></span><br><span class="line">UNNotificationRequest *request =[UNNotificationRequest requestWithIdentifier:requestIdentifier content:content trigger:trigger];</span><br><span class="line"><span class="comment">// 将请求添加到发送中心</span></span><br><span class="line">[[UNUserNotificationCenter currentNotificationCenter] addNotificationRequest:request withCompletionHandler:^(<span class="built_in">NSError</span> * _Nullable error) &#123;</span><br><span class="line">    <span class="keyword">if</span> (error) &#123;</span><br><span class="line">        [<span class="built_in">UIAlertController</span> showConfirmAlertWithMessage:error.localizedDescription Controller:<span class="keyword">self</span>]</span><br><span class="line">    &#125; <span class="keyword">else</span>&#123;</span><br><span class="line">        [<span class="built_in">NSString</span> stringWithFormat:<span class="string">@"时间戳通知\"%@\"已安排"</span>,requestIdentifier];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;];</span><br></pre></td></tr></table></figure></p>
<p><strong>Swift:</strong><br><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 1. 创建通知内容</span></span><br><span class="line"><span class="keyword">let</span> content = <span class="type">UNMutableNotificationContent</span>()</span><br><span class="line">content.title = <span class="string">"时间戳通知"</span></span><br><span class="line">content.body = <span class="string">"我的第一条通知"</span></span><br><span class="line"><span class="comment">// 2. 创建发送触发器</span></span><br><span class="line"><span class="keyword">let</span> trigger = <span class="type">UNTimeIntervalNotificationTrigger</span>(timeInterval: <span class="number">5</span>, repeats: <span class="literal">false</span>)</span><br><span class="line"><span class="comment">// 3. 发送请求标识符</span></span><br><span class="line"><span class="keyword">let</span> requestIdentifier = <span class="string">"com.onevcat.usernotification.myFirstNotification"</span></span><br><span class="line"><span class="comment">// 4. 创建一个发送请求</span></span><br><span class="line"><span class="keyword">let</span> request = <span class="type">UNNotificationRequest</span>(identifier: requestIdentifier, content: content, trigger: trigger)</span><br><span class="line"><span class="comment">// 将请求添加到发送中心</span></span><br><span class="line"><span class="type">UNUserNotificationCenter</span>.current().add(request) &#123; error <span class="keyword">in</span></span><br><span class="line">    <span class="keyword">if</span> error == <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">"Time Interval Notification scheduled: <span class="subst">\(requestIdentifier)</span>"</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<ol>
<li><p>触发器 <code>trigger</code> 是只对本地通知而言的，远程推送的通知的话默认会在收到后立即显示。现在 <code>UserNotifications</code> 框架中提供了三种触发器，分别是：</p>
<ul>
<li><code>UNTimeIntervalNotificationTrigger</code> 在一定时间后触发</li>
<li><code>UNCalendarNotificationTrigger</code> 在某月某日某时触发</li>
<li><code>UNLocationNotificationTrigger</code> 在用户进入或是离开某个区域时触发</li>
</ul>
</li>
<li><p>请求标识符 <code>identifier</code> 可以用来区分不同的通知请求，在将一个通知请求提交后，通过特定 API 我们能够使用这个标识符来取消或者更新这个通知，而这些<code>CURD</code>的操作最重要的也就是这个标识符。</p>
</li>
<li><p>在iOS10的通知框架<code>UserNotification.framework</code>中，苹果的设计思路借用了一部分网络请求的概念。组织并发送一个通知请求，然后将这个请求提交给 <code>UNUserNotificationCenter</code> 用户通知中心进行处理。之后会在 delegate 中接收到这个通知请求对应的 response，另外我们也有机会在应用的 extension 中对 request 进行处理。</p>
</li>
</ol>
<p>在提交通知请求后，只要锁屏或者将应用切到后台，等待设定好的时间后，就能看到通知出现在通知中心或者屏幕横幅了：</p>
<p><img src="https://willjayh.oss-cn-shanghai.aliyuncs.com/imgs/timeInterval通知.png" alt=""></p>
<h3 id="1-4-取消和更新"><a href="#1-4-取消和更新" class="headerlink" title="1.4 取消和更新"></a>1.4 取消和更新</h3><p>在创建通知请求时，我们已经指定了标识符 <code>Identifier</code>。这个标识符<code>Identifier</code>可以用来管理通知。在 iOS 10 之前，我们很难取消掉某一个特定的通知，也不能主动移除或者更新已经展示的通知。想象一下你需要推送用户账户内的余额变化情况，多次的余额增减或者变化很容易让用户十分困惑 - 到底哪条通知才是最正确的？又或者在推送一场比赛的比分时，频繁的通知必然导致用户通知中心数量爆炸，而大部分中途的比分对于用户来说只是噪音。</p>
<p>iOS 10 中，UserNotifications 框架提供了一系列管理通知的 API，你可以做到：</p>
<ul>
<li>取消还未展示的通知</li>
<li>移除已经展示过的通知</li>
<li>更新还未展示的通知</li>
<li>更新已经展示过的通知</li>
</ul>
<p>其中关键就在于在创建请求时使用同样的标识符<code>Identifier</code>。</p>
<h4 id="1-4-1-取消还未展示的通知"><a href="#1-4-1-取消还未展示的通知" class="headerlink" title="1.4.1 取消还未展示的通知"></a>1.4.1 取消还未展示的通知</h4><p>可以使用 <code>removePendingNotificationRequestsWithIdentifiers</code>这个方法，来取消还未展示的通知请求。</p>
<p><strong>Objective-C:</strong><br><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">UNTimeIntervalNotificationTrigger *trigger = [UNTimeIntervalNotificationTrigger triggerWithTimeInterval:<span class="number">3</span> repeats:<span class="literal">NO</span>];</span><br><span class="line"><span class="built_in">NSString</span> *identifier = [NotificationHandler userNotiRawValue:UserNotificationTypePendingRemoval];</span><br><span class="line">UNNotificationRequest *request = [UNNotificationRequest requestWithIdentifier:identifier content:<span class="keyword">self</span>.title1Content trigger:trigger];</span><br><span class="line">[[UNUserNotificationCenter currentNotificationCenter] addNotificationRequest:request withCompletionHandler:^(<span class="built_in">NSError</span> * _Nullable error) &#123;</span><br><span class="line">    <span class="keyword">if</span> (error) &#123;</span><br><span class="line">        [<span class="built_in">UIAlertController</span> showConfirmAlertWithMessage:error.localizedDescription Controller:<span class="keyword">self</span>];</span><br><span class="line">    &#125; <span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="built_in">NSLog</span>(<span class="string">@"通知请求 \"%@\" 被安排发送"</span>, identifier);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;];</span><br><span class="line">[<span class="keyword">self</span> delay:<span class="number">2</span> Operation:^&#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"通知请求 \"%@\" 已经被移除"</span>, identifier);</span><br><span class="line">    [[UNUserNotificationCenter currentNotificationCenter] removePendingNotificationRequestsWithIdentifiers:@[identifier]];</span><br><span class="line">&#125;];</span><br></pre></td></tr></table></figure></p>
<p><strong>Swift:</strong><br><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> trigger = <span class="type">UNTimeIntervalNotificationTrigger</span>(timeInterval: <span class="number">3</span>, repeats: <span class="literal">false</span>)</span><br><span class="line"><span class="keyword">let</span> identifier = <span class="type">UserNotificationType</span>.pendingRemoval.rawValue</span><br><span class="line"><span class="keyword">let</span> request = <span class="type">UNNotificationRequest</span>(identifier: identifier, content: title1Content, trigger: trigger)</span><br><span class="line"></span><br><span class="line"><span class="type">UNUserNotificationCenter</span>.current().add(request) &#123; error <span class="keyword">in</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">let</span> error = error &#123;</span><br><span class="line">        <span class="type">UIAlertController</span>.showConfirmAlert(message: error.localizedDescription, <span class="keyword">in</span>: <span class="keyword">self</span>)</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">"通知请求<span class="subst">\(identifier)</span>被安排发送"</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">delay(<span class="number">2</span>) &#123;</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">"通知请求<span class="subst">\(identifier)</span>已经被移除"</span>)</span><br><span class="line">    <span class="type">UNUserNotificationCenter</span>.current().removePendingNotificationRequests(withIdentifiers: [identifier])</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h4 id="1-4-2-移除已经展示过的通知"><a href="#1-4-2-移除已经展示过的通知" class="headerlink" title="1.4.2 移除已经展示过的通知"></a>1.4.2 移除已经展示过的通知</h4><p>可以使用 <code>removeDeliveredNotificationsWithIdentifiers</code>这个方法，来移除已经展示过的通知请求。</p>
<p><strong>Objective-C:</strong><br><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">UNTimeIntervalNotificationTrigger *trigger = [UNTimeIntervalNotificationTrigger triggerWithTimeInterval:<span class="number">3</span> repeats:<span class="literal">NO</span>];</span><br><span class="line"><span class="built_in">NSString</span> *identifier = [NotificationHandler userNotiRawValue:UserNotificationTypeDeliveredRemoval];</span><br><span class="line">UNNotificationRequest *request = [UNNotificationRequest requestWithIdentifier:identifier content:<span class="keyword">self</span>.title1Content trigger:trigger];</span><br><span class="line">[[UNUserNotificationCenter currentNotificationCenter] addNotificationRequest:request withCompletionHandler:^(<span class="built_in">NSError</span> * _Nullable error) &#123;</span><br><span class="line">    <span class="keyword">if</span> (!error) &#123;</span><br><span class="line">        <span class="built_in">NSLog</span>(<span class="string">@"通知请求 \"%@\" 已被安排发出"</span>, identifier);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;];</span><br><span class="line">[<span class="keyword">self</span> delay:<span class="number">4</span> Operation:^&#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"通知请求 \"%@\" 已经被移除"</span>, identifier);</span><br><span class="line">    [[UNUserNotificationCenter currentNotificationCenter] removeDeliveredNotificationsWithIdentifiers:@[identifier]];</span><br><span class="line">&#125;];</span><br></pre></td></tr></table></figure></p>
<p><strong>Swift:</strong><br><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> trigger = <span class="type">UNTimeIntervalNotificationTrigger</span>(timeInterval: <span class="number">3</span>, repeats: <span class="literal">false</span>)</span><br><span class="line"><span class="keyword">let</span> identifier = <span class="string">"com.onevcat.usernotification.notificationWillBeRemovedAfterDisplayed"</span></span><br><span class="line"><span class="keyword">let</span> request = <span class="type">UNNotificationRequest</span>(identifier: identifier, content: content, trigger: trigger)</span><br><span class="line"><span class="type">UNUserNotificationCenter</span>.current().add(request) &#123; </span><br><span class="line">    error <span class="keyword">in</span></span><br><span class="line">    <span class="keyword">if</span> error != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">"通知请求:<span class="subst">\(identifier)</span>已被安排发出"</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">delay(<span class="number">4</span>) &#123;</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">"通知请求:<span class="subst">\(identifier)</span>已经被移除"</span>)</span><br><span class="line">    <span class="type">UNUserNotificationCenter</span>.current().removeDeliveredNotifications(withIdentifiers: [identifier])</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h4 id="1-4-3-更新通知"><a href="#1-4-3-更新通知" class="headerlink" title="1.4.3 更新通知"></a>1.4.3 更新通知</h4><p>对于更新通知，可以使用 <code>add</code>这个方法，不论是否已经展示，都和一开始添加请求时一样，再次将请求提交给 <code>UNUserNotificationCenter</code> 即可来更新已经展示过的通知请求。</p>
<p><strong>Objective-C:</strong><br><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[[UNUserNotificationCenter currentNotificationCenter] addNotificationRequest:request withCompletionHandler:^(<span class="built_in">NSError</span> * _Nullable error) &#123;</span><br><span class="line">    <span class="keyword">if</span> (!error) </span><br><span class="line">        <span class="built_in">NSLog</span>(<span class="string">@"通知请求 \"%@\" 已被安排发出"</span>, identifier);</span><br><span class="line">&#125;];</span><br><span class="line">[<span class="keyword">self</span> delay:<span class="number">2</span> Operation:^&#123;</span><br><span class="line">    UNTimeIntervalNotificationTrigger *newTrigger = [UNTimeIntervalNotificationTrigger triggerWithTimeInterval:<span class="number">1</span> repeats:<span class="literal">NO</span>];</span><br><span class="line">    UNNotificationRequest *newRequest = [UNNotificationRequest requestWithIdentifier:identifier content:<span class="keyword">self</span>.title2Content trigger:newTrigger];</span><br><span class="line">    [[UNUserNotificationCenter currentNotificationCenter] addNotificationRequest:newRequest withCompletionHandler:^(<span class="built_in">NSError</span> * _Nullable error) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!error) </span><br><span class="line">            <span class="built_in">NSLog</span>(<span class="string">@"通知 \"%@\" 已经被更新"</span>, identifier);</span><br><span class="line">    &#125;];</span><br><span class="line">&#125;];</span><br></pre></td></tr></table></figure></p>
<p><strong>Swift:</strong><br><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">UNUserNotificationCenter</span>.current().add(request) &#123; error <span class="keyword">in</span></span><br><span class="line">    <span class="keyword">if</span> error == <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">"通知请求<span class="subst">\(identifier)</span>已被安排发出"</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">delay(<span class="number">2</span>) &#123;</span><br><span class="line">    <span class="keyword">let</span> newTrigger = <span class="type">UNTimeIntervalNotificationTrigger</span>(timeInterval: <span class="number">1</span>, repeats: <span class="literal">false</span>)</span><br><span class="line">    <span class="keyword">let</span> newRequest = <span class="type">UNNotificationRequest</span>(identifier: identifier, content:newContent, trigger: newTrigger)</span><br><span class="line">    <span class="type">UNUserNotificationCenter</span>.current().add(newRequest) &#123; error <span class="keyword">in</span></span><br><span class="line">        <span class="keyword">if</span> error == <span class="literal">nil</span> &#123;</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">"通知<span class="subst">\(identifier)</span>已经被更新"</span>)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="1-5-处理通知"><a href="#1-5-处理通知" class="headerlink" title="1.5 处理通知"></a>1.5 处理通知</h3><p>先来看看在iOS10之前通知的处理方式，本地通知和远程通知的点击分别进入了两个不同的回调方法：</p>
<ul>
<li><code>application:didReceiveLocalNotification:</code>当用户点击本地通知进入app的时候调用</li>
<li><code>application:didReceiveRemoteNotification:</code> 当用户点击远程通知进入app的时候调用</li>
</ul>
<p>可以看出，如果App正处于前台接收到了通知，虽然方法能够监听到通知，但是前台的通知是无法被展示出来的。</p>
<h4 id="1-5-1-应用内展示通知"><a href="#1-5-1-应用内展示通知" class="headerlink" title="1.5.1 应用内展示通知"></a>1.5.1 应用内展示通知</h4><p>iOS10下的现在，当应用处于前台时，收到的通知是可以通过操作将其展示在前台的。</p>
<p><code>UNUserNotificationCenterDelegate</code> 提供了两个方法，分别对应如何在应用内展示通知，和收到通知响应时要如何处理的工作。我们可以实现这个接口中的对应方法来在应用内展示通知：</p>
<ul>
<li><code>userNotificationCenter: willPresentNotification: withCompletionHandler:</code>通知即将被展示的时候调用</li>
<li><code>userNotificationCenter: didReceiveNotificationResponse: withCompletionHandler:</code>通知被操作点击的时候调用</li>
</ul>
<p><strong>Objective-C:</strong><br><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//__IOS_AVAILABLE(10.0) __TVOS_AVAILABLE(10.0) __WATCHOS_AVAILABLE(3.0)</span></span><br><span class="line">- (<span class="keyword">void</span>)userNotificationCenter:(UNUserNotificationCenter *)center willPresentNotification:(UNNotification *)notification withCompletionHandler:(<span class="keyword">void</span> (^)(UNNotificationPresentationOptions options))completionHandler&#123;</span><br><span class="line"><span class="comment">//    typedef NS_OPTIONS(NSUInteger, UNNotificationPresentationOptions) &#123;</span></span><br><span class="line"><span class="comment">//        UNNotificationPresentationOptionBadge   = (1 &lt;&lt; 0),</span></span><br><span class="line"><span class="comment">//        UNNotificationPresentationOptionSound   = (1 &lt;&lt; 1),</span></span><br><span class="line"><span class="comment">//        UNNotificationPresentationOptionAlert   = (1 &lt;&lt; 2),</span></span><br><span class="line"><span class="comment">//    &#125; __IOS_AVAILABLE(10.0) __TVOS_AVAILABLE(10.0) __WATCHOS_AVAILABLE(3.0);</span></span><br><span class="line">    <span class="comment">// 如果不想显示某个通知，可以直接用空 options 调用 completionHandler(0)</span></span><br><span class="line">    completionHandler(UNNotificationPresentationOptionAlert | UNNotificationPresentationOptionSound);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p><strong>Swift:</strong><br><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">userNotificationCenter</span><span class="params">(<span class="number">_</span> center: UNUserNotificationCenter, </span></span></span><br><span class="line"><span class="function"><span class="params">                   willPresent notification: UNNotification, </span></span></span><br><span class="line"><span class="function"><span class="params">                   withCompletionHandler completionHandler: @escaping <span class="params">(UNNotificationPresentationOptions)</span></span></span> -&gt; <span class="type">Void</span>) </span><br><span class="line">&#123;</span><br><span class="line">    completionHandler([.alert, .sound])</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 如果不想显示某个通知，可以直接用空 options 调用 completionHandler:</span></span><br><span class="line">    <span class="comment">// completionHandler([])</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p><strong>注意：实现这两个方法的实例对象是 <code>UNUserNotificationCenter</code> 的 <code>delegate</code>。推荐在<code>AppDelegate</code> 的 <code>application:didFinishLaunchingWithOptions:</code>方法中为代理赋值，至于为什么推荐在这个方法中为delegate赋值，在接下去会指出。</strong></p>
<p><strong>Objective-C:</strong><br><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="built_in">BOOL</span>)application:(<span class="built_in">UIApplication</span> *)application didFinishLaunchingWithOptions:(<span class="built_in">NSDictionary</span> *)launchOptions &#123;</span><br><span class="line">    <span class="keyword">self</span>.notificationHandler = (<span class="keyword">id</span>)[[NotificationHandler alloc]init];</span><br><span class="line">    [UNUserNotificationCenter currentNotificationCenter].delegate = <span class="keyword">self</span>.notificationHandler;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">YES</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p><strong>Swift:</strong><br><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">AppDelegate</span>: <span class="title">UIResponder</span>, <span class="title">UIApplicationDelegate</span> </span>&#123;</span><br><span class="line">    <span class="keyword">let</span> notificationHandler = <span class="type">NotificationHandler</span>()</span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">application</span><span class="params">(<span class="number">_</span> application: UIApplication, didFinishLaunchingWithOptions launchOptions: [NSObject: AnyObject]?)</span></span> -&gt; <span class="type">Bool</span> &#123;</span><br><span class="line">        <span class="type">UNUserNotificationCenter</span>.current().delegate = notificationHandler</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h4 id="1-5-2-对通知进行响应"><a href="#1-5-2-对通知进行响应" class="headerlink" title="1.5.2 对通知进行响应"></a>1.5.2 对通知进行响应</h4><p><code>UNUserNotificationCenterDelegate</code> 中还有一个方法，<code>userNotificationCenter:didReceive:withCompletionHandler:</code>。<strong>这个代理方法会在用户与你推送的通知进行交互时被调用</strong>，包括用户通过通知打开了你的应用，或者点击或者触发了某个 action (之后会提到 actionable 的通知)。因为涉及到打开应用的行为，所以实现了这个方法的 delegate 必须在 <code>applicationDidFinishLaunching:</code> 返回前就完成设置，这也是我们之前推荐将 <code>NotificationHandler</code> 尽早进行赋值的理由。</p>
<p><strong>Objective-C:</strong><br><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// __IOS_AVAILABLE(10.0) __WATCHOS_AVAILABLE(3.0) __TVOS_PROHIBITED</span></span><br><span class="line">- (<span class="keyword">void</span>)userNotificationCenter:(UNUserNotificationCenter *)center didReceiveNotificationResponse:(UNNotificationResponse *)response withCompletionHandler:(<span class="keyword">void</span>(^)())completionHandler&#123;</span><br><span class="line">    completionHandler();  <span class="comment">// 交给系统来处理执行收到通知之后的操作</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p><strong>Swift:</strong><br><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">userNotificationCenter</span><span class="params">(<span class="number">_</span> center: UNUserNotificationCenter, didReceive response: UNNotificationResponse, withCompletionHandler completionHandler: @escaping <span class="params">()</span></span></span> -&gt; <span class="type">Void</span>) &#123;</span><br><span class="line">    completionHandler()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h2 id="二、可交互通知发送和处理"><a href="#二、可交互通知发送和处理" class="headerlink" title="二、可交互通知发送和处理"></a>二、可交互通知发送和处理</h2><h3 id="2-1-注册-Category"><a href="#2-1-注册-Category" class="headerlink" title="2.1 注册 Category"></a>2.1 注册 Category</h3><p>引入了可以交互的通知，这是通过将一簇 action 放到一个 category 中，将这个 category 进行注册，最后在发送通知时将通知的 category 设置为要使用的 category 来实现的。</p>
<p><img src="https://willjayh.oss-cn-shanghai.aliyuncs.com/imgs/notification-category.png" alt=""></p>
<p>注册一个 category :</p>
<p><strong>Objective-C:</strong><br><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)registerNotificationCategory&#123;</span><br><span class="line">    <span class="comment">//注册Action Category</span></span><br><span class="line">    <span class="built_in">NSString</span> *inputActionId = [NotificationHandler saySomethingRawValue:SaySomethingCategoryActionInput];</span><br><span class="line">    UNTextInputNotificationAction *inputAction = [UNTextInputNotificationAction actionWithIdentifier:inputActionId title:<span class="string">@"输入"</span> options: UNNotificationActionOptionForeground textInputButtonTitle:<span class="string">@"发送"</span> textInputPlaceholder:<span class="string">@"你想说什么..."</span>];</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">NSString</span> *goodbyeActionId = [NotificationHandler saySomethingRawValue:SaySomethingCategoryActionGoodbye];</span><br><span class="line">    UNNotificationAction *goodbyeAction = [UNNotificationAction actionWithIdentifier:goodbyeActionId title:<span class="string">@"再见"</span> options:UNNotificationActionOptionForeground];</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">NSString</span> *cancelActionId = [NotificationHandler saySomethingRawValue:SaySomethingCategoryActionNone];</span><br><span class="line">    UNNotificationAction *cancelAction = [UNNotificationAction actionWithIdentifier:cancelActionId title:<span class="string">@"取消"</span> options:UNNotificationActionOptionForeground];</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">NSString</span> *saySomethingCategoryIdentifier = [NotificationHandler categoryRawValue:UserNotificationCategoryTypeSaySomething];</span><br><span class="line">    UNNotificationCategory *saySomethingCategory = [UNNotificationCategory categoryWithIdentifier:saySomethingCategoryIdentifier actions:@[inputAction, goodbyeAction, cancelAction] intentIdentifiers:@[] options:UNNotificationCategoryOptionCustomDismissAction];</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//将类别集合注册 进入通知中心</span></span><br><span class="line">    <span class="built_in">NSSet</span> *categorySet = [<span class="built_in">NSSet</span> setWithObjects:saySomethingCategory, <span class="literal">nil</span>];</span><br><span class="line">    [[UNUserNotificationCenter currentNotificationCenter] setNotificationCategories:categorySet];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p><strong>Swift:</strong><br><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">func</span> <span class="title">registerNotificationCategory</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="keyword">let</span> saySomethingCategory: <span class="type">UNNotificationCategory</span> = &#123;</span><br><span class="line">        <span class="keyword">let</span> inputAction = <span class="type">UNTextInputNotificationAction</span>(</span><br><span class="line">            identifier: <span class="string">"action.input"</span>,</span><br><span class="line">            title: <span class="string">"输入"</span>,</span><br><span class="line">            options: [.foreground],</span><br><span class="line">            textInputButtonTitle: <span class="string">"发送"</span>,</span><br><span class="line">            textInputPlaceholder: <span class="string">"你想说什么..."</span>)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">let</span> goodbyeAction = <span class="type">UNNotificationAction</span>(</span><br><span class="line">            identifier: <span class="string">"action.goodbye"</span>,</span><br><span class="line">            title: <span class="string">"再见"</span>,</span><br><span class="line">            options: [.foreground])</span><br><span class="line"></span><br><span class="line">        <span class="keyword">let</span> cancelAction = <span class="type">UNNotificationAction</span>(</span><br><span class="line">            identifier: <span class="string">"action.cancel"</span>,</span><br><span class="line">            title: <span class="string">"取消"</span>,</span><br><span class="line">            options: [.destructive])</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="type">UNNotificationCategory</span>(identifier:<span class="string">"saySomethingCategory"</span>, actions: [inputAction, goodbyeAction, cancelAction], intentIdentifiers: [], options: [.customDismissAction])</span><br><span class="line">    &#125;()</span><br><span class="line">    <span class="type">UNUserNotificationCenter</span>.current().setNotificationCategories([saySomethingCategory])</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<ol>
<li><code>UNTextInputNotificationAction</code> 代表一个输入文本的 action，你可以自定义框的按钮 title 和 placeholder。你稍后会使用 identifier 来对 action 进行区分。</li>
<li>普通的 <code>UNNotificationAction</code> 对应标准的按钮。</li>
<li>为 category 指定一个 identifier，我们将在实际发送通知的时候用这个标识符进行设置，这样系统就知道这个通知对应哪个 category 了。</li>
</ol>
<p>当然，不要忘了在程序启动时调用<code>registerNotificationCategory</code>这个方法进行注册</p>
<h3 id="2-2-发送一个带有-action-的通知"><a href="#2-2-发送一个带有-action-的通知" class="headerlink" title="2.2 发送一个带有 action 的通知"></a>2.2 发送一个带有 action 的通知</h3><p>在完成 category 注册后，发送一个 actionable 通知就非常简单了，只需要在创建 <code>UNNotificationContent</code> 时把 categoryIdentifier 设置为需要的 category id 即可：<code>content.categoryIdentifier = @&quot;saySomethingCategory&quot;</code><br>尝试展示这个通知，在下拉或者使用 3D touch 展开通知后，就可以看到对应的 action 了：</p>
<p><img src="https://willjayh.oss-cn-shanghai.aliyuncs.com/imgs/Actionable.png" alt=""></p>
<p>远程推送也可以使用 category，只需要在 <code>payload</code> 中添加 <code>category</code> 字段，并指定预先定义的 <code>category id</code> 就可以了：<br><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"aps"</span>:&#123;</span><br><span class="line">    <span class="attr">"alert"</span>:<span class="string">"Please say something"</span>,</span><br><span class="line">    <span class="attr">"category"</span>:<span class="string">"saySomething"</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="2-3-处理-actionable-通知"><a href="#2-3-处理-actionable-通知" class="headerlink" title="2.3 处理 actionable 通知"></a>2.3 处理 actionable 通知</h3><p>和普通的通知并无二致，actionable 通知也会走到 <code>userNotificationCenter: didReceiveNotificationResponse: withCompletionHandler:</code> 这个代理方法，我们通过 request 中包含的 <code>categoryIdentifier</code> 和 response 里的 <code>actionIdentifier</code> 就可以轻易判定是<strong>哪个通知的哪个操作被执行了</strong>。对于 <code>UNTextInputNotificationAction</code> 触发的 response，直接将它转换为一个 <code>UNTextInputNotificationResponse</code>，就可以拿到其中的用户输入了：</p>
<p><strong>Objective-C:</strong><br><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)userNotificationCenter:(UNUserNotificationCenter *)center didReceiveNotificationResponse:(UNNotificationResponse *)response withCompletionHandler:(<span class="keyword">void</span>(^)())completionHandler&#123;</span><br><span class="line">    <span class="keyword">if</span> (response.notification.request.content.categoryIdentifier.length &gt; <span class="number">0</span>) &#123;<span class="comment">//判断是不是category类型的通知</span></span><br><span class="line">        UserNotificationCategoryType categoryType = [NotificationHandler notiCategoryTypeWithRawValue:response.notification.request.content.categoryIdentifier];</span><br><span class="line">        <span class="keyword">switch</span> (categoryType) &#123;</span><br><span class="line">            <span class="keyword">case</span> UserNotificationCategoryTypeSaySomething:</span><br><span class="line">                [<span class="keyword">self</span> handleSaySomthing:response];</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">default</span>:</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    completionHandler();  <span class="comment">// 交给系统来处理执行收到通知之后的操作</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)handleSaySomthing:(UNNotificationResponse *)response&#123;</span><br><span class="line">    <span class="built_in">NSString</span> *text = <span class="string">@""</span>;</span><br><span class="line">    SaySomethingCategoryAction actionType = [NotificationHandler categoryActionWithRawValue:response.actionIdentifier];</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (actionType) &#123;</span><br><span class="line">        <span class="keyword">switch</span> (actionType) &#123;</span><br><span class="line">            <span class="keyword">case</span> SaySomethingCategoryActionInput:</span><br><span class="line">                text = [(UNTextInputNotificationResponse *)response userText];</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> SaySomethingCategoryActionGoodbye:</span><br><span class="line">                text = <span class="string">@"再见"</span>;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> SaySomethingCategoryActionNone:</span><br><span class="line">                text = <span class="string">@""</span>;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">default</span>:</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (text.length &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        [<span class="built_in">UIAlertController</span> showConfirmAlertFromTopViewControllerWithMessage:[<span class="built_in">NSString</span> stringWithFormat:<span class="string">@"你刚刚说：\"%@\" "</span>, text]];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p><strong>Swift:</strong><br><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">userNotificationCenter</span><span class="params">(<span class="number">_</span> center: UNUserNotificationCenter, didReceive response: UNNotificationResponse, withCompletionHandler completionHandler: @escaping <span class="params">()</span></span></span> -&gt; <span class="type">Void</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">let</span> category = <span class="type">UserNotificationCategoryType</span>(rawValue: response.notification.request.content.categoryIdentifier) &#123;</span><br><span class="line">        <span class="keyword">switch</span> category &#123;</span><br><span class="line">        <span class="keyword">case</span> .saySomething:</span><br><span class="line">            handleSaySomthing(response: response)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    completionHandler()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">func</span> <span class="title">handleSaySomthing</span><span class="params">(response: UNNotificationResponse)</span></span> &#123;</span><br><span class="line">    <span class="keyword">let</span> text: <span class="type">String</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">let</span> actionType = <span class="type">SaySomethingCategoryAction</span>(rawValue: response.actionIdentifier) &#123;</span><br><span class="line">        <span class="keyword">switch</span> actionType &#123;</span><br><span class="line">        <span class="keyword">case</span> .input: text = (response <span class="keyword">as</span>! <span class="type">UNTextInputNotificationResponse</span>).userText</span><br><span class="line">        <span class="keyword">case</span> .goodbye: text = <span class="string">"再见"</span></span><br><span class="line">        <span class="keyword">case</span> .<span class="keyword">none</span>: text = <span class="string">""</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        text = <span class="string">""</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> !text.isEmpty &#123;</span><br><span class="line">        <span class="type">UIAlertController</span>.showConfirmAlertFromTopViewController(message: <span class="string">"你刚刚说：<span class="subst">\(text)</span>"</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>上面的代码先判断通知响应是否属于 “saySomething”，然后从用户输入或者是选择中提取字符串，并且弹出一个 alert 作为响应结果。</p>
<p><img src="https://willjayh.oss-cn-shanghai.aliyuncs.com/imgs/saySomething.png" alt=""></p>
<p>当然了，在实际的App开发中，这种 actionable通知 的情况可能更多的是用户的一个action会发送一个对应的网络请求，或者更新一些 UI 等。</p>
<h2 id="三、Notification-Extension"><a href="#三、Notification-Extension" class="headerlink" title="三、Notification Extension"></a>三、Notification Extension</h2><p>iOS 10 中添加了很多 extension，作为应用与系统整合的入口。与通知相关的 extension 有两个：</p>
<ul>
<li><code>Service Extension</code> 可以让我们有机会在收到远程推送的通知后，展示之前对通知内容进行修改</li>
<li><code>Content Extension</code> 用来自定义通知视图的样式</li>
</ul>
<p><img src="https://willjayh.oss-cn-shanghai.aliyuncs.com/imgs/notification-extensions.png" alt=""></p>
<h3 id="3-1-截取并修改通知内容"><a href="#3-1-截取并修改通知内容" class="headerlink" title="3.1 截取并修改通知内容"></a>3.1 截取并修改通知内容</h3><p><strong>Objective-C:</strong><br><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)didReceiveNotificationRequest:(UNNotificationRequest *)request withContentHandler:(<span class="keyword">void</span> (^)(UNNotificationContent * _Nonnull))contentHandler &#123;</span><br><span class="line">    <span class="keyword">self</span>.contentHandler = contentHandler;</span><br><span class="line">    <span class="keyword">self</span>.bestAttemptContent = [request.content mutableCopy];</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">self</span>.bestAttemptContent) &#123;</span><br><span class="line">        <span class="keyword">if</span> ([request.identifier isEqualToString:<span class="string">@"mutableContent"</span>]) &#123;</span><br><span class="line">            ;</span><br><span class="line">            <span class="keyword">self</span>.bestAttemptContent.body = [<span class="built_in">NSString</span> stringWithFormat:<span class="string">@"%@, 科比·布莱恩特"</span>,<span class="keyword">self</span>.bestAttemptContent.body];</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> ([request.identifier isEqualToString:<span class="string">@"media"</span>])&#123;</span><br><span class="line">            <span class="built_in">NSString</span> *imageURLString = [<span class="keyword">self</span>.bestAttemptContent.userInfo objectForKey:<span class="string">@"image"</span>];</span><br><span class="line">            <span class="built_in">NSURL</span> *URL = [<span class="built_in">NSURL</span> URLWithString:imageURLString];</span><br><span class="line">            <span class="keyword">if</span> (URL) &#123;</span><br><span class="line">                __<span class="keyword">weak</span> <span class="keyword">typeof</span>(<span class="keyword">self</span>) weakSelf = <span class="keyword">self</span>;</span><br><span class="line">                [<span class="keyword">self</span> downloadAndSave:URL handler:^(<span class="built_in">NSURL</span> *localURL) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (localURL) &#123;</span><br><span class="line">                       UNNotificationAttachment *attachment = [UNNotificationAttachment attachmentWithIdentifier:<span class="string">@"image_downloaded"</span> URL:localURL options:<span class="literal">nil</span> error:<span class="literal">nil</span>];</span><br><span class="line">                        weakSelf.bestAttemptContent.attachments = @[attachment];</span><br><span class="line">                    &#125;</span><br><span class="line">                    weakSelf.contentHandler(<span class="keyword">self</span>.bestAttemptContent);</span><br><span class="line">                &#125;];</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">self</span>.bestAttemptContent.title = [<span class="built_in">NSString</span> stringWithFormat:<span class="string">@"%@ [modified]"</span>, <span class="keyword">self</span>.bestAttemptContent.title];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p><strong>Swift:</strong><br><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">NotificationService</span>: <span class="title">UNNotificationServiceExtension</span> </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> contentHandler: ((<span class="type">UNNotificationContent</span>) -&gt; <span class="type">Void</span>)?</span><br><span class="line">    <span class="keyword">var</span> bestAttemptContent: <span class="type">UNMutableNotificationContent</span>?</span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">func</span> <span class="title">didReceive</span><span class="params">(<span class="number">_</span> request: UNNotificationRequest, withContentHandler contentHandler: @escaping <span class="params">(UNNotificationContent)</span></span></span> -&gt; <span class="type">Void</span>) &#123;</span><br><span class="line">        <span class="keyword">self</span>.contentHandler = contentHandler</span><br><span class="line">        bestAttemptContent = (request.content.mutableCopy() <span class="keyword">as</span>? <span class="type">UNMutableNotificationContent</span>)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">let</span> bestAttemptContent = bestAttemptContent &#123;</span><br><span class="line">            <span class="keyword">if</span> request.identifier == <span class="string">"mutableContent"</span> &#123;</span><br><span class="line">                bestAttemptContent.body = <span class="string">"<span class="subst">\(bestAttemptContent.body)</span>, 科比·布莱恩特"</span></span><br><span class="line">            &#125;</span><br><span class="line">            contentHandler(bestAttemptContent)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">func</span> <span class="title">serviceExtensionTimeWillExpire</span><span class="params">()</span></span> &#123;</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">let</span> contentHandler = contentHandler, <span class="keyword">let</span> bestAttemptContent =  bestAttemptContent &#123;</span><br><span class="line">            contentHandler(bestAttemptContent)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<ol>
<li><code>didReceiveNotificationRequest withContentHandler:</code> 方法中有一个等待发送的通知请求，我们通过修改这个请求中的 content 内容，然后在限制的时间内将修改后的内容调用通过 contentHandler 返还给系统，就可以显示这个修改过的通知了。</li>
<li>在一定时间内没有调用 contentHandler 的话，系统会调用<code>serviceExtensionTimeWillExpire</code>这个方法，来告诉你大限已到。你可以选择什么都不做，这样的话系统将当作什么都没发生，简单地显示原来的通知。可能你其实已经设置好了绝大部分内容，只是有很少一部分没有完成，这时你也可以像例子中这样调用 contentHandler 来显示一个变更“中途”的通知。</li>
</ol>
<p>Service Extension 现在只对远程推送的通知起效.<br>你可以在推送 payload 中增加一个 mutable-content 值为 1 的项来启用内容修改：</p>
<h3 id="3-2-多媒体通知推送"><a href="#3-2-多媒体通知推送" class="headerlink" title="3.2 多媒体通知推送"></a>3.2 多媒体通知推送</h3><h4 id="3-2-1-发送本地多媒体通知"><a href="#3-2-1-发送本地多媒体通知" class="headerlink" title="3.2.1 发送本地多媒体通知"></a>3.2.1 发送本地多媒体通知</h4><p>相比于旧版本的通知，iOS 10 中另一个亮眼功能是多媒体的推送。开发者现在可以在通知中嵌入图片或者视频，这极大丰富了推送内容的可读性和趣味性。</p>
<p>为本地通知添加多媒体内容十分简单，只需要通过本地磁盘上的文件 URL 创建一个 UNNotificationAttachment 对象，然后将这个对象放到数组中赋值给 content 的 attachments 属性就行了：</p>
<p><strong>Objective-C:</strong><br><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">UNMutableNotificationContent *content = [[UNMutableNotificationContent alloc]init];</span><br><span class="line">content.title = <span class="string">@"精彩瞬间"</span>;</span><br><span class="line">content.body = <span class="string">@"科比·布莱恩特！夺冠时刻！"</span>;</span><br><span class="line"><span class="built_in">NSArray</span> *imageNames = @[<span class="string">@"image"</span>, <span class="string">@"onecat"</span>];</span><br><span class="line"><span class="built_in">NSMutableArray</span> *attachments = [<span class="built_in">NSMutableArray</span> array];</span><br><span class="line"><span class="keyword">for</span> (<span class="built_in">NSString</span> *imgName <span class="keyword">in</span> imageNames) &#123;</span><br><span class="line">    <span class="built_in">NSURL</span> *imgURL = [[<span class="built_in">NSBundle</span> mainBundle]URLForResource:imgName withExtension:<span class="string">@"jpg"</span>];</span><br><span class="line">    <span class="built_in">NSString</span> *identifier = [<span class="built_in">NSString</span> stringWithFormat:<span class="string">@"image-%@"</span>,imgName];</span><br><span class="line">    UNNotificationAttachment *attachment = [UNNotificationAttachment attachmentWithIdentifier:identifier URL:imgURL options:<span class="literal">nil</span> error:<span class="literal">nil</span>];</span><br><span class="line">    [attachments addObject:attachment];</span><br><span class="line">&#125;</span><br><span class="line">content.attachments = attachments;</span><br></pre></td></tr></table></figure></p>
<p><strong>Swift:</strong><br><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> content = <span class="type">UNMutableNotificationContent</span>()</span><br><span class="line">content.title = <span class="string">"精彩瞬间"</span></span><br><span class="line">content.body = <span class="string">"科比·布莱恩特！夺冠时刻！"</span></span><br><span class="line"><span class="keyword">if</span> <span class="keyword">let</span> imageURL = <span class="type">Bundle</span>.main.url(forResource: <span class="string">"image"</span>, withExtension: <span class="string">"jpg"</span>),</span><br><span class="line">   <span class="keyword">let</span> attachment = <span class="keyword">try</span>? <span class="type">UNNotificationAttachment</span>(identifier: <span class="string">"imageAttachment"</span>, url: imageURL, options: <span class="literal">nil</span>)</span><br><span class="line">&#123;</span><br><span class="line">    content.attachments = [attachment]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>在显示时，横幅或者弹窗将附带设置的图片，使用 3D Touch pop 通知或者下拉通知显示详细内容时，图片也会被放大展示：</p>
<p><img src="https://willjayh.oss-cn-shanghai.aliyuncs.com/imgs/mediaNotification.png" alt=""><br><img src="https://willjayh.oss-cn-shanghai.aliyuncs.com/imgs/mediaNotificationDetail.png" alt=""></p>
<p>除了图片以外，通知还支持音频以及视频。你可以将 MP3 或者 MP4 这样的文件提供给系统来在通知中进行展示和播放。</p>
<blockquote>
<p>不过，这些文件都有尺寸的限制，</p>
<ul>
<li>图片不能超过 5MB，</li>
<li>视频不能超过 50MB</li>
</ul>
</blockquote>
<p>关于支持的文件格式和尺寸，可以在文档中进行确认。在创建<code>UNNotificationAttachment</code> 时，如果遇到了不支持的格式，SDK 也会抛出错误。</p>
<h4 id="3-2-2-远程推送多媒体通知"><a href="#3-2-2-远程推送多媒体通知" class="headerlink" title="3.2.2 远程推送多媒体通知"></a>3.2.2 远程推送多媒体通知</h4><p>这要借助 <code>Notification Service Extension</code> 来修改推送通知内容的技术。<br>一般做法是，我们在推送的 payload 中指定需要加载的图片资源地址，这个地址可以是应用 bundle 内已经存在的资源，也可以是网络的资源。不过因为在创建 <code>UNNotificationAttachment</code> 时我们只能使用本地资源，所以如果多媒体还不在本地的话，我们需要先将其下载到本地。在完成 UNNotificationAttachment 创建后，我们就可以和本地通知一样，将它设置给 attachments 属性，然后调用 contentHandler 了。</p>
<p>示例 payload 如下：<br><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"aps"</span>:&#123;</span><br><span class="line">    <span class="attr">"alert"</span>:&#123;</span><br><span class="line">      <span class="attr">"title"</span>:<span class="string">"Image Notification"</span>,</span><br><span class="line">      <span class="attr">"body"</span>:<span class="string">"Show me an image from web!"</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">"mutable-content"</span>:<span class="number">1</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">"image"</span>: <span class="string">"https://onevcat.com/assets/images/background-cover.jpg"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p><code>mutable-content</code> 表示我们会在接收到通知时对内容进行更改，<code>image</code> 指明了目标图片的地址。<br>在 <code>NotificationService</code> 里，加入如下代码来下载图片，并将其保存到磁盘缓存中：</p>
<p><strong>Objective-C:</strong><br><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)downloadAndSave:(<span class="built_in">NSURL</span> *)url handler:(<span class="keyword">void</span>(^)(<span class="built_in">NSURL</span> *localURL))handler&#123;</span><br><span class="line">    <span class="built_in">NSURLSessionDataTask</span> *task = [[<span class="built_in">NSURLSession</span> sharedSession] dataTaskWithURL:url completionHandler:^(<span class="built_in">NSData</span> * _Nullable data, <span class="built_in">NSURLResponse</span> * _Nullable response, <span class="built_in">NSError</span> * _Nullable error) &#123;</span><br><span class="line">        <span class="built_in">NSURL</span> *loccalURL;</span><br><span class="line">        <span class="keyword">if</span> (data) &#123;</span><br><span class="line">            <span class="built_in">NSString</span> *ext = url.absoluteString.pathExtension;</span><br><span class="line">            <span class="built_in">NSURL</span> *cacheURL = [<span class="built_in">NSURL</span> fileURLWithPath:<span class="built_in">NSSearchPathForDirectoriesInDomains</span>(<span class="built_in">NSCachesDirectory</span>, <span class="built_in">NSUserDomainMask</span>, <span class="literal">YES</span>).firstObject];</span><br><span class="line">            </span><br><span class="line">            <span class="built_in">NSURL</span> *urlPath = [[cacheURL URLByAppendingPathComponent:url.absoluteString.md5] URLByAppendingPathExtension:ext];</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">if</span> ([data writeToURL:urlPath atomically:<span class="literal">YES</span>]) &#123;</span><br><span class="line">                loccalURL = urlPath;</span><br><span class="line">            &#125;;</span><br><span class="line">        &#125;</span><br><span class="line">        handler(loccalURL);</span><br><span class="line">    &#125;];</span><br><span class="line">    [task resume];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p><strong>Swift:</strong><br><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">func</span> <span class="title">downloadAndSave</span><span class="params">(url: URL, handler: @escaping <span class="params">(<span class="number">_</span> localURL: URL?)</span></span></span> -&gt; <span class="type">Void</span>) &#123;</span><br><span class="line">    <span class="keyword">let</span> task = <span class="type">URLSession</span>.shared.dataTask(with: url, completionHandler: &#123;</span><br><span class="line">        data, res, error <span class="keyword">in</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">var</span> localURL: <span class="type">URL</span>? = <span class="literal">nil</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">let</span> data = data &#123;</span><br><span class="line">            <span class="keyword">let</span> ext = (url.absoluteString <span class="keyword">as</span> <span class="type">NSString</span>).pathExtension</span><br><span class="line">            <span class="keyword">let</span> cacheURL = <span class="type">URL</span>(fileURLWithPath: <span class="type">FileManager</span>.<span class="keyword">default</span>.cachesDirectory)</span><br><span class="line">            <span class="keyword">let</span> url = cacheURL.appendingPathComponent(url.absoluteString.md5).appendingPathExtension(ext)</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">let</span> <span class="number">_</span> = <span class="keyword">try</span>? data.write(to: url) &#123;</span><br><span class="line">                localURL = url</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        handler(localURL)</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    task.resume()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>然后在 <code>didReceiveNotificationRequest: withContentHandler</code> 中，接收到这类通知时提取图片地址，下载，并生成 attachment，进行通知展示：</p>
<p><strong>Objective-C:</strong><br><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">NSString</span> *imageURLString = [<span class="keyword">self</span>.bestAttemptContent.userInfo objectForKey:<span class="string">@"image"</span>];</span><br><span class="line"><span class="built_in">NSURL</span> *URL = [<span class="built_in">NSURL</span> URLWithString:imageURLString];</span><br><span class="line"><span class="keyword">if</span> (URL) &#123;</span><br><span class="line">    __<span class="keyword">weak</span> <span class="keyword">typeof</span>(<span class="keyword">self</span>) weakSelf = <span class="keyword">self</span>;</span><br><span class="line">    [<span class="keyword">self</span> downloadAndSave:URL handler:^(<span class="built_in">NSURL</span> *localURL) &#123;</span><br><span class="line">        <span class="keyword">if</span> (localURL) &#123;</span><br><span class="line">           UNNotificationAttachment *attachment = [UNNotificationAttachment attachmentWithIdentifier:<span class="string">@"image_downloaded"</span> URL:localURL options:<span class="literal">nil</span> error:<span class="literal">nil</span>];</span><br><span class="line">            weakSelf.bestAttemptContent.attachments = @[attachment];</span><br><span class="line">        &#125;</span><br><span class="line">        weakSelf.contentHandler(<span class="keyword">self</span>.bestAttemptContent);</span><br><span class="line">    &#125;];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p><strong>Swift:</strong><br><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> <span class="keyword">let</span> imageURLString = bestAttemptContent.userInfo[<span class="string">"image"</span>] <span class="keyword">as</span>? <span class="type">String</span>,</span><br><span class="line">   <span class="keyword">let</span> <span class="type">URL</span> = <span class="type">URL</span>(string: imageURLString)</span><br><span class="line">&#123;</span><br><span class="line">    downloadAndSave(url: <span class="type">URL</span>) &#123; localURL <span class="keyword">in</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">let</span> localURL = localURL &#123;</span><br><span class="line">            <span class="keyword">do</span> &#123;</span><br><span class="line">                <span class="keyword">let</span> attachment = <span class="keyword">try</span> <span class="type">UNNotificationAttachment</span>(identifier: <span class="string">"image_downloaded"</span>, url: localURL, options: <span class="literal">nil</span>)</span><br><span class="line">                bestAttemptContent.attachments = [attachment]</span><br><span class="line">            &#125; <span class="keyword">catch</span> &#123;</span><br><span class="line">                <span class="built_in">print</span>(error)</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        contentHandler(bestAttemptContent)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="3-3-自定义通知视图样式"><a href="#3-3-自定义通知视图样式" class="headerlink" title="3.3 自定义通知视图样式"></a>3.3 自定义通知视图样式</h3><p>iOS 10 SDK 新加的另一个 <code>Content Extension</code> 可以用来自定义通知的详细页面的视图。新建一个 <code>Notification Content Extension</code>，Xcode 为我们准备的模板中包含了一个实现了：</p>
<ul>
<li><code>NotificationViewController</code> : <code>UNNotificationContentExtension</code> 的 <code>UIViewController</code> 子类;</li>
<li><code>MainInterface.stroyboard</code>：自定义UI视图的一个storyboard;</li>
<li><code>info.plist</code>：用来配置一些内容。</li>
</ul>
<h4 id="3-3-1-普通自定义UI的通知实现"><a href="#3-3-1-普通自定义UI的通知实现" class="headerlink" title="3.3.1 普通自定义UI的通知实现"></a>3.3.1 普通自定义UI的通知实现</h4><p>这个 extension 中有一个必须实现的方法 <code>didReceiveNotification:notification</code>，在系统需要显示自定义样式的通知详情视图时，这个方法将被调用，你需要在其中配置你的 UI。而 UI 本身可以通过这个 extension 中的 <code>MainInterface.storyboard</code> 来进行定义。自定义 UI 的通知是和通知 category 绑定的，我们需要在 extension 的 Info.plist 里指定这个通知样式所对应的 category 标识符：</p>
<p><img src="https://willjayh.oss-cn-shanghai.aliyuncs.com/imgs/info_plist.png" alt=""></p>
<p>系统在接收到通知后会先查找有没有能够处理这类通知的 content extension，如果存在，那么就交给 extension 来进行处理。<br>另外，在构建 UI 时，我们可以通过 Info.plist 控制通知详细视图的尺寸，以及是否显示原始的通知。</p>
<p><strong>虽然我们可以使用包括按钮在内的各种 UI，但是系统不允许我们对这些 UI 进行交互。点击通知视图 UI 本身会将我们导航到应用中。</strong></p>
<p><img src="https://willjayh.oss-cn-shanghai.aliyuncs.com/imgs/customUINoti.png" alt=""></p>
<p>不过我们可以通过 action 的方式来对自定义 UI 进行更新。<code>UNNotificationContentExtension</code> 为我们提供了一个可选方法 <code>didReceiveNotificationResponse: completionHandler:</code>，它会在用户选择了某个 action 时被调用，你有机会在这里更新通知的 UI。</p>
<p><strong>Objective-C:</strong><br><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)didReceiveNotification:(UNNotification *)notification &#123;</span><br><span class="line">    UNNotificationContent *content = notification.request.content;</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">NSArray</span> *items = [content.userInfo objectForKey:<span class="string">@"items"</span>];</span><br><span class="line">    <span class="built_in">NSInteger</span> i = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="built_in">NSDictionary</span> *item <span class="keyword">in</span> items) &#123;</span><br><span class="line">        <span class="built_in">NSString</span> *title = [item objectForKey:<span class="string">@"title"</span>];</span><br><span class="line">        <span class="built_in">NSString</span> *text = [item objectForKey:<span class="string">@"text"</span>];</span><br><span class="line">        <span class="keyword">if</span> (!title.length || !text.length) &#123;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">NSURL</span> *url = content.attachments[i].URL;</span><br><span class="line">        </span><br><span class="line">        NotificationPresentItem *presentItem = [NotificationPresentItem itemWithURL:url Title:title Text:text];</span><br><span class="line">        [<span class="keyword">self</span>.items addObject:presentItem];</span><br><span class="line">        i++;</span><br><span class="line">    &#125;</span><br><span class="line">    [<span class="keyword">self</span> updateUI:<span class="number">0</span>];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)updateUI:(<span class="built_in">NSInteger</span>)index&#123;</span><br><span class="line">    NotificationPresentItem *item = <span class="keyword">self</span>.items[index];</span><br><span class="line">    <span class="keyword">if</span> (item.url.startAccessingSecurityScopedResource)&#123;</span><br><span class="line">        <span class="keyword">self</span>.imageView.image = [<span class="built_in">UIImage</span> imageWithContentsOfFile:item.url.path];</span><br><span class="line">        [item.url stopAccessingSecurityScopedResource];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">self</span>.label.text = item.title;</span><br><span class="line">    <span class="keyword">self</span>.textView.text = item.text;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">self</span>.index = index;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p><strong>Swift:</strong><br><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">didReceive</span><span class="params">(<span class="number">_</span> notification: UNNotification)</span></span> &#123;</span><br><span class="line">    <span class="keyword">let</span> content = notification.request.content</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">let</span> items = content.userInfo[<span class="string">"items"</span>] <span class="keyword">as</span>? [[<span class="type">String</span>: <span class="type">AnyObject</span>]] &#123;</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="number">0</span>..&lt;items.<span class="built_in">count</span> &#123;</span><br><span class="line">            <span class="keyword">let</span> item = items[i]</span><br><span class="line">            <span class="keyword">guard</span> <span class="keyword">let</span> title = item[<span class="string">"title"</span>] <span class="keyword">as</span>? <span class="type">String</span>, <span class="keyword">let</span> text = item[<span class="string">"text"</span>] <span class="keyword">as</span>? <span class="type">String</span> <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">continue</span></span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> i &gt; content.attachments.<span class="built_in">count</span> - <span class="number">1</span> &#123;</span><br><span class="line">                <span class="keyword">continue</span></span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">let</span> url = content.attachments[i].url</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">let</span> presentItem = <span class="type">NotificationPresentItem</span>(url: url, title: title, text: text)</span><br><span class="line">            <span class="keyword">self</span>.items.append(presentItem)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    updateUI(index: <span class="number">0</span>)</span><br><span class="line">&#125;</span><br><span class="line">    </span><br><span class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">func</span> <span class="title">updateUI</span><span class="params">(index: Int)</span></span> &#123;</span><br><span class="line">    <span class="keyword">let</span> item = items[index]</span><br><span class="line">    <span class="keyword">if</span> item.url.startAccessingSecurityScopedResource() &#123;</span><br><span class="line">        imageView.image = <span class="type">UIImage</span>(contentsOfFile: item.url.path)</span><br><span class="line">        item.url.stopAccessingSecurityScopedResource()</span><br><span class="line">    &#125;</span><br><span class="line">    label.text = item.title</span><br><span class="line">    textView.text = item.text</span><br><span class="line">    <span class="keyword">self</span>.index = index</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h4 id="3-3-2-有UI更新的自定义通知"><a href="#3-3-2-有UI更新的自定义通知" class="headerlink" title="3.3.2 有UI更新的自定义通知"></a>3.3.2 有UI更新的自定义通知</h4><p>如果有 UI 更新，那么在方法的 completionHandler 中，开发者可以选择传递 <code>UNNotificationContentExtensionResponseOptionDoNotDismiss</code> 来保持通知继续被显示。如果没有继续显示的必要，可以选择 </p>
<ul>
<li><code>UNNotificationContentExtensionResponseOptionDismissAndForwardAction</code> 把通知的 <code>action</code> 继续传递给应用的 <code>UNUserNotificationCenterDelegate</code> 中的<code>userNotificationCenter:didReceiveNotificationResponse:withCompletionHandler:</code> </li>
<li><code>UNNotificationContentExtensionResponseOptionDismiss</code>，直接解散这个通知。</li>
</ul>
<p><strong>Objective-C:</strong><br><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)didReceiveNotificationResponse:(UNNotificationResponse *)response completionHandler:(<span class="keyword">void</span> (^)(UNNotificationContentExtensionResponseOption))completion&#123;</span><br><span class="line">    <span class="keyword">if</span> ([response.actionIdentifier isEqualToString:<span class="string">@"switch1"</span>]) &#123;</span><br><span class="line">        <span class="built_in">NSInteger</span> nextIndex;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">self</span>.index == <span class="number">0</span>) &#123;</span><br><span class="line">            nextIndex = <span class="number">1</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span>&#123;</span><br><span class="line">            nextIndex = <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        [<span class="keyword">self</span> updateUI:nextIndex];</span><br><span class="line">        completion(UNNotificationContentExtensionResponseOptionDoNotDismiss);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> ([response.actionIdentifier isEqualToString:<span class="string">@"open2"</span>]) &#123;</span><br><span class="line">        completion(UNNotificationContentExtensionResponseOptionDismissAndForwardAction);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> ([response.actionIdentifier isEqualToString:<span class="string">@"dismiss3"</span>])  &#123;</span><br><span class="line">        completion(UNNotificationContentExtensionResponseOptionDismiss);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        completion(UNNotificationContentExtensionResponseOptionDismissAndForwardAction);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p><strong>Swift:</strong><br><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">didReceive</span><span class="params">(<span class="number">_</span> response: UNNotificationResponse, completionHandler completion: @escaping <span class="params">(UNNotificationContentExtensionResponseOption)</span></span></span> -&gt; <span class="type">Void</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> response.actionIdentifier == <span class="string">"switch"</span> &#123;</span><br><span class="line">        <span class="keyword">let</span> nextIndex: <span class="type">Int</span></span><br><span class="line">        <span class="keyword">if</span> index == <span class="number">0</span> &#123;</span><br><span class="line">            nextIndex = <span class="number">1</span></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            nextIndex = <span class="number">0</span></span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        updateUI(index: nextIndex)</span><br><span class="line">        completion(.doNotDismiss)</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> response.actionIdentifier == <span class="string">"open"</span> &#123;</span><br><span class="line">        completion(.dismissAndForwardAction)</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> response.actionIdentifier == <span class="string">"dismiss"</span> &#123;</span><br><span class="line">        completion(.dismiss)</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        completion(.dismissAndForwardAction)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<blockquote>
<p>注：如果你的自定义 UI 包含视频等，你还可以实现 <code>UNNotificationContentExtension</code> 里的 media 开头的一系列属性，它将为你提供一些视频播放的控件和相关方法。</p>
</blockquote>

  </section>

</article>

<section class="read-more">
           
    
               
            <div class="read-more-item">
                <span class="read-more-item-dim">最近的文章</span>
                <h2 class="post-list__post-title post-title"><a href="/2017/04/现代化OC语法/" title="现代化OC语法">现代化OC语法</a></h2>
                <p class="excerpt">
                
                随着Swift的加入，OC在不也在不断向着新的编程方式靠拢，虽然OC是我很喜欢的一门很优雅的语言，但是毕竟编程讲究的是效率，时代的大浪下，OC的很多写法也顺应大潮做出了一些相应的改变。下面我们来看一下都有哪些地方现代化OC语法做出的改变。
##1. 将一些单纯的方法转换为属性12- (BOOL)is
                &hellip;
                </p>
                <div class="post-list__meta"><time datetime="2017-04-11T01:31:10.000Z" class="post-list__meta--date date">2017-04-11</time> &#8226; <span class="post-list__meta--tags tags">于&nbsp;
  <a class="tag-link" href="/tags/能工巧匠集/">能工巧匠集</a>
</span><a class="btn-border-small" href="/2017/04/现代化OC语法/">继续阅读</a></div>
                           
            </div>
        
        
               
            <div class="read-more-item">
                <span class="read-more-item-dim">更早的文章</span>
                <h2 class="post-list__post-title post-title"><a href="/2016/09/OC进化简述/" title="OC进化简述">OC进化简述</a></h2>
                <p class="excerpt">
                
                Objective-C 最初起源于 NeXTSTEP 操作系统，之后乔布斯回到苹果，便将它在OS X和iOS中继承了下来。20世纪80年代初，Brad Box和Tom Love以SmallTalk-80语言为基础发明了Objective-C，Smalltalk是历史上第二个面向对象的程序设计语言，也
                &hellip;
                </p>
                <div class="post-list__meta"><time datetime="2016-09-28T08:37:46.000Z" class="post-list__meta--date date">2016-09-28</time> &#8226; <span class="post-list__meta--tags tags">于&nbsp;
  <a class="tag-link" href="/tags/能工巧匠集/">能工巧匠集</a>
</span><a class="btn-border-small" href="/2016/09/OC进化简述/">继续阅读</a></div>
                       
            </div>
        
     
   
   
  
</section>

  

            <footer class="footer">
    <span class="footer__copyright">
        本站点采用 <a href="http://creativecommons.org/licenses/by-nc-sa/4.0/">知识共享署名-非商业性使用-相同方式共享 4.0 国际许可协议</a>
    </span>
    <span class="footer__copyright">
        基于 <a href="http://hexo.io">Hexo</a> 搭建，感谢 <a href="https://pages.github.com/">GitHub Pages</a> 提供免费的托管服务
    </span>
    <span class="footer__copyright">
        &copy; 2023 - 本站使用 <a href="https://github.com/monniya/hexo-theme-new-vno ">new-vno</a> 主题,
        由<a href="https://monniya.com ">@Monniya</a> 修改自 <a href="https://github.com/lenbo-ma/hexo-theme-vno" target="_blank">Vno</a>, 原创出自<a href="http://github.com/onevcat/vno" target="_blank">onevcat</a>
    </span>
    
</footer>


        </div>
    </div>

     
    


    <script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    
    
</body>
</html>
